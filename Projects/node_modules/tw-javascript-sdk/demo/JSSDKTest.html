<!DOCTYPE html>
<html>
<head>
    <meta charset='ISO-8859-1'>
    <title>JavaScript SDK Test</title>
</head>
<body>
<div>
    <span>String Prop:&nbsp;</span><span id='stringProp'></span>
</div>
<div>
    <span>Int Prop:&nbsp;</span><span id='intProp'></span>
</div>
<div>
    <input id='subscribe' type='button' value='Subscribe'/><br/>
    <input id='unsubscribe' type='button' value='Unsubscribe'/><br/>
</div>

<!-- Assumes this is running in /Thingworx/demos. -->
<script src='../Common/jquery/jquery.js'></script>
<script src='../Common/underscore/underscore.js'></script>
<script src='uuid.js'></script>
<script src='tw-javascript-sdk-0.1.0.js'></script>
<script>
    var bind = $('#bind');
    var subscribe = $('#subscribe');
    var unsubscribe = $('#unsubscribe');
    var intProp = $('#intProp');
    var stringProp = $('#stringProp');
    stringProp.text('not set');
    intProp.text('not set');
    var appName = "JSSSDKTest";
    var appKeyId = ''; // could be hard-coded and skip the getAppKey function

    // Get an app key for auth.
    var getAppKey = function () {
        if (appKeyId !== '') {
            startup();
            return;
        }
        
        var createAppKeyURL = 'http://localhost:8080/Thingworx/Resources/EntityServices/Services/GetClientApplicationKey';
        var appKeyParams = {
            appKeyName: appName + 'key',
            clientName: appName
        };
        $.ajax({
            url: createAppKeyURL,
            type: 'POST',
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify(appKeyParams),
            success: function (data) {
                appKeyId = data.rows[0].result;
                startup();
            },
            error: function (xhr, status) {
                // do something
            }
        });
    };

    // Start up and initialize the edge client
    var startup = function () {
        var config = {
            host: 'localhost',
            port: 8080,
            appKey: appKeyId,
            ssl: false
        };
        
        var subscriptionManager = new TW.SubscriptionManager(config);

        // Event handler for the remote subscriptions. This could be any platform event
        // HandleSubscribedEvent manages forwarding the event to this handler
        var handler = function (payload) {
            var source = payload.source;
            var property = payload.sourceProperty;
            var data = payload.eventData.rows[0].newValue.rows[0].value;
            
            if (source === 'TestThing1') {
                if (property === 'IntProp') {
                    intProp.text(data);
                } else if (property === 'StringProp') {
                    stringProp.text(data);
                }
            }
        };
        
        var addSubscriptions = function() {
            subscriptionManager.subscribe({
                sourceType: "Things",
                source: "TestThing1",
                sourceProperty: "IntProp",
                eventName: "DataChange"
            }, handler);
            
            subscriptionManager.subscribe({
                sourceType: "Things",
                source: "TestThing1",
                sourceProperty: "StringProp",
                eventName: "DataChange"
            }, handler);
        };
        
        var removeSubscriptions = function() {
            subscriptionManager.unsubscribe({
                sourceType: "Things",
                source: "TestThing1",
                sourceProperty: "IntProp",
                eventName: "DataChange"
            }, handler);
            
            subscriptionManager.unsubscribe({
                sourceType: "Things",
                source: "TestThing1",
                sourceProperty: "StringProp",
                eventName: "DataChange"
            }, handler);
        };

        // button handlers
        subscribe.click(function () {
            addSubscriptions();
        });
        
        unsubscribe.click(function () {
            removeSubscriptions();
        });
    };

    getAppKey();
</script>

</body>
</html>