"use strict";

const fs = require('fs-extra');
const path = require('path');
var log;

/**
 * Do upgrade work for projects older than 1.10
 * @param {object} params - the same params given to onupgrade func + removeSync func
 * @param logger - logs to console & upgrade.log
 */
function onupgrade(params, logger) {
  log = logger;
  try {
    const node_modules_dir = path.join(params.path, 'node_modules');
    if (fs.existsSync(node_modules_dir)) {
      const nmstats = fs.lstatSync(node_modules_dir);
      if(nmstats.isDirectory()) {
        if(fs.readdirSync(node_modules_dir).length === 0) {
          // on Windows, copying a project dir via File Explorer drag n drop -> 'Copy here' results in an empty node_modules dir
          // if dir is empty just remove it
          log.debug('Remove empty node_modules directory, rely upon the link in the parent projects directory.');
          fs.removeSync(node_modules_dir);
        } else {
          log.debug('Non-symlink & non-empty node_modules directory found inside project. Leaving it alone.');
        }
      } else {
        log.debug('Remove node-modules sym-link, rely upon the link in the parent projects directory.');
        fs.unlinkSync(node_modules_dir);
      }
    }
  }
  catch (e) {
    log.error('Did not find or could not remove node_modules sym-link', e);
  }
}

module.exports = {
  version: '1.9.0',
  range: '<1.9.0 || 1.9.x',
  onupgrade: onupgrade
};