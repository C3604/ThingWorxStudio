#!/bin/bash -eu
DEVOPS_DIR=$(cd `dirname $0` && pwd)

NODE_VERSION=6.10.0

shopt -s dotglob nullglob

echo
echo "Beginning NodeJS version ${NODE_VERSION} installation to ${DEVOPS_DIR}/node"
echo

if [ -x "$DEVOPS_DIR/node/bin/node" ] ; then
    INSTALLED_VERSION=$("$DEVOPS_DIR"/node/bin/node --version)
    echo "Found installed version: $INSTALLED_VERSION"

    if [ "v${NODE_VERSION}" == "$INSTALLED_VERSION" ] ; then
        echo "Node version ${NODE_VERSION} already installed!"
        exit 0;
    else
        echo "Removing different version of node: ${INSTALLED_VERSION}"
    fi
fi

if [ -d "$DEVOPS_DIR/node" ] ; then
    echo "Blowing away old installation"
    rm -rf "$DEVOPS_DIR/node"
fi

mkdir -p "$DEVOPS_DIR/node"

NODE_MIRROR_PREFIX="${NODE_MIRROR_PREFIX:-http://cpmdev-nexus.rd1.thingworx.io:8081/content/sites/nodejs-mirror}"

if [[ "$(uname)" = "Darwin" ]]; then
    PLATFORM="darwin"
else
    PLATFORM="linux"
fi

curl -sSL -o "$DEVOPS_DIR/node/node.tar.gz" $NODE_MIRROR_PREFIX/v${NODE_VERSION}/node-v${NODE_VERSION}-${PLATFORM}-x64.tar.gz
tar -xC "$DEVOPS_DIR/node" -f "$DEVOPS_DIR/node/node.tar.gz"
mv "$DEVOPS_DIR/node/node-v${NODE_VERSION}-${PLATFORM}-x64/"* "$DEVOPS_DIR/node/"
rmdir "$DEVOPS_DIR/node/node-v${NODE_VERSION}-${PLATFORM}-x64"
rm "$DEVOPS_DIR/node/node.tar.gz"
echo "Node installed to ${DEVOPS_DIR}/node"
