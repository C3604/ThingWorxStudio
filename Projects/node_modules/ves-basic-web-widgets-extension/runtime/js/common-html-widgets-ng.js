/* begin copyright text
 *
 * Copyright Â© 2016 PTC Inc., Its Subsidiary Companies, and /or its Partners. All Rights Reserved.
 *
 * end copyright text
 */
(function () {
  'use strict';

  var twxMobileModule = angular.module('common-html-widgets-ng', [])
    .directive('twxTabs', ['$compile', twxTabs])
    .directive('twxTab', ['$compile', twxTab])
    .directive('twxPopupService', twxPopupService);

  function twxPopupService() {
    return {
      restrict: 'A',
      link: function (scope, element, attrs) {
        scope.hidepopup = function() {
          element.addClass('hidden');
        };
        scope.showpopup = function() {
          element.removeClass('hidden');
        };
        scope.$on('serviceInvoke', function(evt, data) {
          var name = data.serviceName;
          if (scope[name]) {
            scope[name](data.params); // Invoke the method if its found
          }
        });
      }
    };
  }

  function twxTabs($compile){

    var linker = function(scope, element, attrs){
      //element.html(getTemplate(element));
      //$compile(element.contents())(scope);
      scope.stripclass = attrs.stripclass;
    };


    return {
      restrict: 'E',
      link: linker,
      template: function (elem) {
        return '<div class="button-bar bar-light tabs-strip"></div><div class="tab-content">' + elem.html() + '</div>';
      },
      controller: ['$scope', '$element', '$parse', function ($scope, $element, $parse) {
        $scope._tabElements = [];

        this.registerTab = function (tabElement) {
          $scope._tabElements.push(tabElement);
          var tabEl = document.createElement('div');
          tabEl.className = 'button button-outline tab-strip-item ' + $element.attr('stripclass');
          var tabStripEl = document.querySelector('.tabs-strip');
          tabStripEl.appendChild(tabEl);
          //select the first tab when loaded
          if($scope._tabElements.length > 0){
            angular.element(document.querySelector('.tab-strip-item')).addClass('active');
          }

          tabEl.addEventListener('click', function(event){
            angular.element(document.querySelectorAll('.tab-strip-item')).removeClass('active');
            angular.forEach($scope._tabElements, function(tab){
              tab.css('display', 'none');
            });
            tabElement.css('display', 'block');
            angular.element(tabEl).addClass('active');
            try {
              var fn = $parse($element.attr('clicktab'), /* interceptorFn */ null, /* expensiveChecks */ true);
              fn($scope, {$event: event});
            } catch(err) {
              console.log(err);
            }
          });
          if ($scope._tabElements.length > 1) {
            tabElement.css('display', 'none');
          }
          return tabEl;
        };
      }]
    };
  }

  function twxTab($compile) {
    var linker = function (scope, element, attrs, controllers) {

      element.tabsController = controllers[0];
      element.tabItemEl = element.tabsController.registerTab(element);

      attrs.$observe('title', function (value) {
        element.tabItemEl.textContent = value;
      });
    };

    return {
      restrict: 'E',
      require: ["^twxTabs"],
      link: linker
    };
  }

  twxMobileModule.directive('twxLink', twxLink);

  function twxLink($window) {
    return {
      restrict: 'EA',
      link: function(scope, element, attr) {
        if ($window.inf) {
          scope.$watch('me.url', function(newVal, oldVal) {
            if (newVal) {
              $window.inf.allowIntent(newVal);
            }
          });
        }
      }

    };
  }
}());
