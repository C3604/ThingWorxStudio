(function(angular) {
    'use strict';

    //Retrieve Studio's services module...
    var app = angular.module('app.services');

    //...and add our new service.
    app.service('ThingworxDataProvider', function($http, $q) {
        var root = '';

        var GetURLRoot = function() {
            return root;
        };

        this.SetURLRoot = function(rootURL) {
            root = rootURL;
        };

        this.GetEntities = function(data) {
            var searchText = data.searchExpression;
            if ((searchText.lastIndexOf('*') + 1) < searchText.length) {
                searchText += '*';
            }
            if( searchText === '' ) {
                searchText = '**';
            }
            data.searchExpression = searchText;
            data.types = {
                items: [
                    'Thing',
                    'ThingTemplate',
                    'ThingShape',
                    'Resource',
                    'Subsystem',
                    'Log'
                ]
            };

            var URL = GetURLRoot() + '/Resources/SearchFunctions/Services/SpotlightSearch';

            var deferred = $q.defer();

            $http.post(URL, data, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }}).then(
                function(response){
                    deferred.resolve(response.data.rows);
                },
                function(response){
                    deferred.reject(response);
                }
            );
            return deferred.promise;
        };

        this.GetStateDefinitions = function(name) {
            var URL = GetURLRoot() + '/StateDefinitions/';
            if (name) {
                URL += encodeURIComponent(name);
            }
            return $http({
                method: 'GET',
                url: URL
            })
        };

        this.GetStyleDefinitions = function(name) {
            var URL = GetURLRoot() + '/StyleDefinitions/';
            if (name) {
                URL += encodeURIComponent(name);
            }
            return $http({
                method: 'GET',
                url: URL
            })
        }

        this.GetMetadata = function(entityType, entityName) {
            var URL = GetURLRoot() + '/' + encodeURIComponent(entityType) + '/' + encodeURIComponent(entityName) + '/Metadata';

            var deferred = $q.defer();

            $http.get(URL, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }}).then(
                function(response){
                    deferred.resolve(response.data);
                },
                function(response){
                    deferred.reject(response);
                }
            );
            return deferred.promise;
        };

        return this;
    });

    //Register this data provider when Vuforia Studio loads
    twxAppBuilder.registerDataProvider('ThingworxDataProvider');

}(angular));